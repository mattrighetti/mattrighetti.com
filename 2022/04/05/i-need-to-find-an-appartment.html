<!DOCTYPE html>
<html lang="en-US" data-theme="dark">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml"/>

    <title>I Need to Find an Apartment</title>

    <meta name="title" content="I Need to Find an Apartment">
    <meta name="description" content="Long story short: I&#8217;ve taken a new position in Luxembourg and I have tofind an apartment, in a different country, in a reasonably short time.">

    <meta property="twitter:title" content="I Need to Find an Apartment">
    <meta property="og:type" content="webiste">

    <meta property="og:title" content="I Need to Find an Apartment">
    <meta property="og:description" content="Long story short: I&#8217;ve taken a new position in Luxembourg and I have tofind an apartment, in a different country, in a reasonably short time.">
    <meta property="twitter:description" content="Long story short: I&#8217;ve taken a new position in Luxembourg and I have tofind an apartment, in a different country, in a reasonably short time.">
    
    <meta property="twitter:url" content="https://mattrighetti.com/2022/04/05/i-need-to-find-an-appartment.html">
    <meta property="og:url" content="https://mattrighetti.com/2022/04/05/i-need-to-find-an-appartment.html">
    

    

    <link rel="canonical" href="https://mattrighetti.com/2022/04/05/i-need-to-find-an-appartment.html">
    <link rel="alternate" type="application/rss+xml" title="mattrighetti" href="https://mattrighetti.com/feed.xml">
    <link rel="stylesheet" href=" /css/style.css">
    <link rel="stylesheet" href=" /css/code.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://kit.fontawesome.com/6e5845808c.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav>
        <a class="-title" href="/">
            <div class="logo">
                <?xml version="1.0" standalone="no"?> <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"> <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="476.000000pt" height="440.000000pt" viewBox="0 0 476.000000 440.000000" preserveAspectRatio="xMidYMid meet" id="icon"> <g transform="translate(0.000000,440.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none"> <path d="M2003 3812 c-182 -62 -283 -171 -354 -382 -41 -124 -50 -259 -24 -376 19 -89 37 -124 63 -124 15 0 146 171 268 348 1 2 32 -20 68 -47 213 -161 482 -274 721 -302 171 -20 212 -5 186 67 -18 51 -74 143 -116 194 -20 24 -34 44 -32 47 2 2 35 -4 72 -12 62 -15 70 -15 84 -1 13 14 13 22 3 62 -47 174 -163 285 -333 317 -32 6 -59 14 -59 17 0 3 26 19 58 35 45 24 58 36 60 57 5 41 -44 53 -213 53 -140 0 -164 -5 -267 -50 -16 -6 -17 -3 -11 26 4 19 7 48 8 64 0 29 -2 30 -50 33 -34 1 -76 -7 -132 -26z"/> <path d="M3347 3243 c-18 -17 -1 -44 68 -113 l75 -75 -80 -80 c-59 -59 -79 -86 -74 -98 3 -9 13 -17 21 -17 17 0 178 152 195 184 9 16 -4 33 -83 112 -89 90 -107 102 -122 87z"/> <path d="M3653 2914 c-13 -35 23 -44 182 -44 159 0 193 8 179 43 -5 15 -25 17 -180 17 -153 0 -175 -2 -181 -16z"/> <path d="M1573 2853 c-56 -86 23 -297 119 -318 30 -7 33 -14 42 -102 4 -43 25 -107 62 -189 3 -5 -98 -64 -223 -130 -252 -132 -301 -166 -355 -245 -43 -62 -311 -763 -328 -858 -26 -146 46 -285 204 -390 l40 -26 1121 0 c1085 0 1122 1 1150 19 74 47 143 118 175 178 29 54 35 75 38 148 l4 85 -132 355 c-150 405 -166 444 -216 511 -45 62 -122 112 -367 239 -156 80 -198 106 -194 119 3 9 17 44 32 78 14 35 28 92 32 128 6 65 6 65 47 84 23 10 54 32 69 50 66 78 78 271 17 271 -22 0 -22 0 -20 -87 1 -67 -21 -134 -57 -165 -10 -10 -37 -21 -59 -26 l-39 -8 -11 -86 c-16 -117 -37 -177 -90 -248 -104 -142 -275 -214 -448 -189 -208 29 -372 197 -398 407 -16 125 -15 122 -48 122 -85 0 -162 166 -116 249 28 51 -19 73 -51 24z m412 -791 c198 -119 458 -89 635 74 l55 51 230 -121 c261 -137 289 -157 339 -229 38 -56 309 -767 321 -844 9 -60 -11 -145 -48 -200 -18 -26 -60 -68 -95 -95 l-63 -48 -95 0 -94 0 0 198 0 197 78 45 c74 44 95 71 73 93 -7 7 -29 -1 -71 -27 -34 -20 -66 -36 -71 -36 -5 0 -9 115 -9 280 0 311 -2 323 -63 360 -31 19 -56 20 -852 20 -805 0 -821 0 -853 -20 -58 -36 -62 -58 -62 -369 l0 -279 -69 40 c-71 40 -91 42 -91 8 0 -12 26 -34 80 -67 l79 -48 1 -197 0 -198 -92 0 c-73 0 -99 4 -123 19 -63 39 -125 103 -152 159 -23 48 -28 69 -27 132 0 71 7 93 137 438 75 199 146 381 158 404 43 83 100 126 354 260 l240 127 50 -48 c28 -27 73 -63 100 -79z m1084 -347 c16 -8 34 -28 40 -46 7 -22 11 -190 11 -526 l0 -493 -862 2 -863 3 -3 485 c-2 326 1 497 8 522 20 71 -24 67 853 68 674 0 792 -2 816 -15z"/> <path d="M1773 2854 c-3 -9 7 -57 23 -106 39 -124 45 -128 196 -128 158 0 170 6 198 103 12 39 23 78 25 85 3 6 20 12 39 12 34 0 35 -1 61 -80 38 -115 47 -120 201 -120 155 0 163 5 200 134 14 49 23 95 20 102 -4 12 -86 14 -481 14 -429 0 -476 -2 -482 -16z"/> <path d="M3105 2658 c-3 -8 -4 -79 -3 -158 3 -137 4 -145 23 -145 19 0 20 7 20 155 0 140 -2 155 -18 158 -9 2 -19 -3 -22 -10z"/> <path d="M3294 2661 c-48 -20 -64 -58 -64 -147 0 -94 12 -129 51 -150 33 -17 60 -18 92 -3 42 19 57 59 57 153 0 80 -2 88 -27 116 -30 32 -75 45 -109 31z m64 -63 c7 -7 12 -42 12 -89 0 -83 -11 -103 -52 -97 -22 3 -23 8 -26 86 -3 87 5 112 37 112 9 0 22 -5 29 -12z"/> <path d="M3515 2658 c-3 -8 -4 -79 -3 -158 3 -137 4 -145 23 -145 19 0 20 7 20 155 0 140 -2 155 -18 158 -9 2 -19 -3 -22 -10z"/> <path d="M3704 2661 c-48 -20 -64 -58 -64 -147 0 -94 12 -129 51 -150 52 -27 115 -8 137 41 7 14 12 64 12 110 0 78 -2 87 -27 115 -30 32 -75 45 -109 31z m65 -65 c8 -9 11 -45 9 -98 l-3 -83 -29 -3 c-16 -2 -32 2 -37 10 -13 20 -11 162 3 176 16 16 43 15 57 -2z"/> <path d="M3342 2218 c-14 -14 -17 -275 -3 -296 5 -8 17 -12 27 -10 17 3 19 15 22 147 2 97 -1 148 -9 157 -14 17 -21 18 -37 2z"/> <path d="M3514 2220 c-12 -4 -31 -21 -43 -37 -21 -25 -22 -37 -19 -126 3 -94 4 -100 31 -123 32 -27 75 -31 116 -9 41 21 54 61 50 159 -4 76 -7 88 -29 110 -28 27 -75 39 -106 26z m64 -62 c7 -7 12 -44 12 -95 0 -78 -2 -84 -22 -92 -46 -17 -58 2 -58 92 0 84 9 107 40 107 9 0 21 -5 28 -12z"/> <path d="M3774 2220 c-12 -4 -31 -21 -43 -36 -18 -23 -21 -40 -21 -121 0 -91 1 -96 29 -124 47 -47 132 -33 159 26 14 31 16 163 2 199 -16 44 -84 74 -126 56z m64 -62 c13 -13 17 -156 4 -174 -15 -22 -42 -24 -62 -4 -26 26 -28 134 -4 168 17 24 43 29 62 10z"/> <path d="M3981 2221 c-8 -5 -11 -50 -9 -157 3 -141 4 -149 23 -149 19 0 20 8 23 151 2 121 0 153 -11 157 -8 3 -19 2 -26 -2z"/> </g> </svg>
                <?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg  PUBLIC '-//W3C//DTD SVG 20010904//EN'  'http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd'>
<svg id="name" width="1834pt" height="492pt" version="1.0" viewBox="0 0 1834 492" xmlns="http://www.w3.org/2000/svg">
<g transform="translate(0 492) scale(.1 -.1)">
<path d="m5013 3880c-28-12-47-78-38-139 3-25 17-97 31-159 14-63 26-148 27-190 1-43 5-79 8-82 6-4 51-622 46-626-1-1-66-11-144-22-142-21-195-39-240-82-23-21-29-55-15-78 10-15 66-32 108-32 26 0 189 38 280 65 20 6 22 2 28-52 40-372 68-602 77-636 24-91 81-155 118-132 19 11 12 139-15 256-42 186-58 289-88 546l-6 51 157 37c545 127 732 192 835 293 77 74 86 142 19 142-15 0-68-24-118-54-125-74-206-111-358-161-122-41-396-107-496-121l-46-6-6 68c-10 109-27 715-24 869 2 116-1 148-16 188-25 64-63 81-124 57z"/>
<path d="m6303 3808c-37-47-41-162-9-284 26-101 36-228 43-531l6-293h-55c-79 0-221-27-273-51-87-41-121-112-70-145 34-22 107-15 258 26 61 16 120 30 130 30 15 0 17-12 17-112 1-170 29-758 38-798 14-55 33-80 64-80 55 0 65 67 39 280-27 219-40 378-48 575l-6 162 94 12c200 26 323 32 565 29 205-2 254 0 268 11 45 37-14 91-121 111-81 16-349 8-622-18l-183-17 3 490c3 451 2 494-15 540-21 59-38 75-82 75-17 0-36-6-41-12z"/>
<path d="m14570 3807c-13-7-30-24-37-37-20-40-15-152 12-268 33-144 54-322 80-683l7-86-144-6c-154-6-196-14-249-50-27-18-35-31-37-59-4-43 18-62 81-73 30-6 37-11 32-24-4-9-14-47-22-86-21-93-51-159-102-223-188-237-716-381-1066-292-112 29-177 62-239 120-107 101-122 203-50 349 56 114 160 214 284 274 116 56 212 79 304 75l69-3-52-57c-54-59-236-188-356-252-94-50-130-79-145-116-25-59 27-117 95-104 100 18 446 280 520 393 128 195-54 359-311 280-85-26-126-47-229-113-111-72-196-154-259-250-77-115-99-187-94-301 5-84 12-110 56-197 2-5-14-8-35-8s-65-12-98-25c-35-14-63-21-68-16-15 15-25 90-37 267-13 202-25 305-47 376-94 317-375 390-643 167-72-60-197-224-268-351l-50-89-6 43c-3 24-11 196-17 383-14 473-33 747-55 813-45 137-147 151-161 21-5-55 3-106 47-269 45-168 72-540 68-935-3-207-2-223 19-267 23-51 46-68 91-68 71 0 139 86 187 238 68 212 208 386 370 457 135 60 215 7 264-175 25-93 39-180 46-290 14-225 43-329 109-396 94-95 266-80 313 27 17 38 18 40 33 22 19-21 37-33 105-69 237-126 622-123 990 6 345 122 564 358 568 612l1 67 89 21c49 11 92 20 96 20 5 0 11-44 15-97 11-158 46-453 61-521 25-106 77-182 125-182 46 0 41 75-16 276-27 97-61 310-70 446-7 96-7 97 17 102 13 3 134 24 269 46 271 44 531 105 600 140 25 12 63 37 86 56l41 33 7-67c11-122 12-120-36-126-213-24-246-33-300-84-33-30-36-64-8-92s96-26 231 6c61 15 113 24 116 20 3-3 8-47 9-98 2-51 10-181 18-288 20-262 38-353 79-397 25-28 41-29 67-3 28 28 26 76-10 269-16 89-34 219-40 289-5 70-12 155-15 190-4 46-2 64 7 67 25 8 336 44 473 54 77 6 222 13 323 16l183 5-15-27c-24-48-39-182-38-338 1-160 16-260 53-346 36-82 95-106 124-49 14 26 13 38-2 122-24 135-24 376 1 493 21 102 18 145-17 196-57 84-129 92-512 55-148-15-317-31-375-36s-129-12-158-16l-53-6 1 409c2 350 0 415-14 459-22 71-59 100-104 83-54-20-65-124-32-301 17-94 40-301 40-366 0-18-4-22-19-17-10 3-63-10-117-29-55-19-144-51-200-70-125-45-331-89-534-114-85-11-156-19-158-17-7 6-23 341-31 640-5 169-14 316-20 337-13 41-56 98-74 98-7 0-23-6-37-13z"/>
<path d="m16812 3634c-64-45 36-113 109-73 18 9 17 12-22 50-45 43-55 46-87 23z"/>
<path d="m9253 3489c-51-19-11-53 62-53 50-1 75 7 63 20-18 17-105 41-125 33z"/>
<path d="m1503 3271c-110-28-231-130-314-266l-46-75-7 62c-4 34-14 75-22 90-13 24-20 29-47 26-61-6-87-102-87-317 0-181-15-336-50-506-49-238-72-388-67-438 8-90 72-134 123-86 35 32 44 78 44 215 0 141 32 415 61 529 53 205 159 413 267 522 72 71 163 123 218 123 106 0 218-144 269-344 47-185 55-342 28-521-25-163-23-218 6-249 30-31 50-33 85-5 40 32 52 63 85 227 33 162 57 234 116 352 81 160 168 266 283 341 153 100 229 93 296-30 78-144 104-288 111-626 4-137 11-279 16-315 22-137 111-237 193-216 40 10 43 43 8 80-69 72-76 112-96 546-22 447-53 570-172 679-84 77-163 96-279 66-165-43-323-206-470-487l-55-103v52c0 70-36 274-62 353-51 157-118 245-223 295-64 30-154 41-212 26z"/>
<path d="m3775 2986c-119-31-215-93-335-216-138-143-245-338-270-495-31-193 61-359 234-422 56-20 169-19 241 2 97 28 212 92 283 158 17 17 32 28 32 23 0-24 170 193 226 290 9 16 13 8 23-51 20-121 61-267 93-335 44-91 136-182 202-199 82-20 146 5 146 59 0 36-15 46-75 53-43 4-55 11-87 46-42 48-101 182-129 296-15 61-22 128-26 280-4 163-9 208-24 243-10 23-22 42-28 42s-26 24-44 53c-48 73-91 111-170 148-57 26-83 32-155 35-52 2-107-2-137-10zm207-146c45-13 88-56 119-120 13-26 32-50 41-53 21-6 15-63-18-164-80-244-287-450-510-507-191-49-301 17-312 188-3 48 1 93 12 136 18 70 83 210 97 210 5 0 9 6 9 14 0 25 143 168 211 211 124 80 255 111 351 85z"/>
<path d="m10106 2939c-224-56-387-214-442-430-21-82-14-202 15-281 36-93 135-190 229-222l35-12-48-40c-27-21-90-80-141-131-300-300-376-645-204-934 50-85 166-204 263-273 151-106 372-195 535-215 282-36 503 101 589 363 48 149 43 503-13 880-8 55-12 106-9 114s1 20-4 26c-16 21-46 395-35 451 5 30 13 38 52 55 70 31 112 67 112 96 0 38-39 49-124 35-58-10-71-9-78 2-4 8-21 20-37 27-37 15-61 4-121-61-40-42-62-54-190-104-80-32-194-82-253-112l-109-55-76 4c-183 11-282 132-253 313 38 244 278 411 507 352 89-23 128-51 195-138 67-89 104-114 143-99 46 17 46 97 1 176-31 53-118 132-177 162-52 25-180 59-248 64-25 2-76-4-114-13zm647-927c86-452 112-685 105-935-4-140-9-173-31-242-31-93-79-169-137-215-283-224-944 37-1082 428-81 233 28 522 287 758 142 129 206 170 276 178 139 16 346 96 474 184 33 23 62 42 65 42s22-89 43-198z"/>
<path d="m7905 2921c-114-19-215-79-286-168-19-23-39-37-54-38-67-2-101-96-92-255 3-58 11-148 17-200 5-52 14-178 19-280 8-192 22-254 64-288 24-20 67-10 90 19 35 48 39 110 16 242-32 189-40 317-28 447 16 187 50 271 128 323 56 37 111 49 235 49 174 0 288-32 541-149 175-81 241-101 274-83 65 34-21 124-202 210-277 133-554 198-722 171z"/>
<path d="m9158 2700c-9-6-24-33-33-60-14-43-16-85-13-260 1-116 6-210 11-210 4 0 7-39 7-87 1-125 16-265 35-323 21-62 63-100 112-100 84 0 149 83 119 154-17 41-28 48-70 48h-33l-11 82c-7 50-9 194-6 378 4 254 2 303-11 335-9 20-21 41-28 45-17 11-59 9-79-2z"/>
</g>
</svg>

            </div>
        </a>
        
        
        
        
        
        
        
        <a href="/about.html">About</a>
        
        
        
        
        
        
        
        
        
        <a href="/projects.html">Projects</a>
        
        
        
        
        
        <a href="/resume.html">Resume</a>
        
        
        
        
        
        
        
        
        
        
        
        <button id="theme-toggle" class="toggle" type="button">
            <span class="d-block-light d-none"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
            <span class="d-block-dark d-none"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
        </button>
    </nav>

    <main>
        <article>
  <h1>I Need to Find an Apartment</h1>
  <div class="post-meta sect1">Apr 5, 2022</div>
  <div class="discuss-on-hn"><a href="https://news.ycombinator.com/item?id=30968721">Discuss on HN</a></div>
  <div class="paragraph">
<p>Long story short: I&#8217;ve taken a new position in Luxembourg and I have to
find an apartment, in a different country, in a reasonably short time.</p>
</div>
<div class="openblock note">
<div class="content">
<div class="paragraph">
<p><strong>TL;DR:</strong> I hate apartment hunting, I&#8217;ve tried to make it as interesting
as possible by creating a pipeline with different tools and languages
to <em>scrape</em> data from a website with the use of Puppeteer, load data into
a SQLite database using Go and visualizing all the data with Python and Folium.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If you want to look at the final code or follow along with me
you can checkout the project repo on
<a href="https://github.com/mattrighetti/athome-scraper">GitHub</a>.</p>
</div>
<div class="paragraph">
<p>I initially sketched what I was looking for by priority</p>
</div>
<div class="imageblock">
<div class="content">
<svg preserveAspectRatio="xMidYMid meet" viewBox="0 0 700 571" xmlns="http://www.w3.org/2000/svg" width="500"><g transform="matrix(.1 0 0 -.1 0 571)"><path d="m1092 4878c-5-7-17-40-27-73-22-76-52-135-109-212-28-39-53-63-65-63-27 0-44-26-37-55 6-23 21-30 55-25 17 2 51 42 120 139l53 76-5-275c-3-151-11-291-17-311-14-49 1-92 32-87 14 2 25 13 30 33 12 40 26 825 16 848-10 20-31 22-46 5z"/><path d="m2167 4779c-110-26-183-116-124-153 22-14 51 3 55 33 4 27 39 50 92 62 62 14 120-15 149-73 32-66 28-87-26-140-58-55-85-70-129-70-52 0-65 16-62 76 3 48 2 51-21 51-19 0-27-7-34-30-13-44-25-467-14-482 28-37 89 5 67 46-5 11-10 78-10 149v128h63c80 0 128 25 196 101 45 51 51 63 51 103-1 83-54 162-132 194-41 18-64 18-121 5z"/><path d="m3850 4597c-32-14-67-21-117-21-98-2-113-16-83-77 19-41 21-54 14-169-8-158 4-228 47-264 55-47 140-43 188 8 39 41 1 76-45 41-21-16-81-20-102-6-28 17-43 150-19 168 6 6 31 13 54 17 66 10 114 36 111 61-3 23-42 33-62 16-7-6-34-14-60-17l-46-7v66c0 70 14 97 50 97 32 0 126 39 145 60 15 16 15 22 5 35-16 19-25 18-80-8z"/><path d="m2990 4595c-17-20-29-141-29-292-1-67-6-144-13-172-13-59-1-84 41-79 26 3 26 4 28 103 2 55 7 176 12 270 8 129 7 171-2 177-17 11-23 10-37-7z"/><path d="m3374 4590c-63-25-125-193-126-341-3-218 133-302 256-157 40 46 43 59 20 79-13 11-22 6-61-34-49-51-85-66-107-48-74 62-54 336 31 433 21 23 43 11 43-23 0-35 30-55 60-39 40 22 11 102-45 126-39 16-42 16-71 4z"/><path d="m2502 4529c-73-36-90-60-68-94 15-23 15-37 1-328-4-83-3-89 18-96 12-5 29-5 39 0 14 8 16 24 11 126l-4 118 49 23c59 26 103 28 124 5 27-31 55-96 61-142 6-51 25-75 51-65 45 17-24 226-87 265-18 10-36 20-41 22s1 22 13 45c30 59 25 119-13 144-26 17-95 7-154-23zm128-51c0-33-48-108-76-119-41-15-44-12-44 49 0 51 3 60 23 70 60 29 97 29 97 0z"/><path d="m1264 4052c-40-27-7-100 38-83 32 12 36 54 6 75-25 18-29 19-44 8z"/><path d="m1906 3895c-19-19-21-51-3-62 6-4 44-8 82-9 39-1 196-11 350-23 562-42 724-51 943-51 141 0 222-4 222-10 0-13 46-13 71 0 22 12 25 43 7 58-8 6-150 12-353 15-187 3-396 10-465 16-200 17-242 20-490 37-215 14-264 20-326 39-13 4-27 1-38-10z"/><path d="m1878 3794c-20-6-31-34-23-56 7-17 60-32 76-22 5 3 182-6 392-20 210-13 506-30 657-36s311-15 355-20 117-9 162-9c45-1 85-5 88-11 9-14 58-13 73 2 17 17 15 46-5 56-10 5-90 12-178 16-88 3-207 10-265 16-58 5-233 14-390 20-346 12-802 44-900 63-14 3-33 3-42 1z"/><path d="m976 2959c-41-28-47-35-44-63 3-27 7-31 33-31 23 0 33 7 43 28 33 68 82 31 82-62 0-71-68-277-139-421-84-170-77-180 119-180 117 0 141 3 160 18 13 10 19 23 15 33-5 13-25 15-140 11-98-3-135-1-135 7 0 6 20 51 44 99s64 149 90 225c65 194 63 303-6 351-34 24-70 19-122-15z"/><path d="m5300 2971c-5-11-10-56-10-101 0-92-8-113-50-135-27-14-30-14-49 11-23 29-28 83-11 115 15 26-4 59-33 59-38 0-47-18-41-84 13-138 66-196 148-162 43 18 42 21 51-134 8-152 18-190 50-190 30 0 39 27 26 77-6 21-15 104-21 184-9 129-8 151 6 185 20 46 22 140 5 172-15 28-56 29-71 3z"/><path d="m4920 2934c-19-9-93-32-165-53-142-42-167-60-139-99 19-28 64-30 71-3 6 25 30 34 37 15 10-25 28-245 22-261-10-26 13-54 41-51 35 4 52 32 35 58-6 11-12 41-12 67 0 46-16 172-25 203-3 11 21 23 100 48 103 34 126 51 104 78-14 17-25 17-69-2z"/><path d="m2253 2878c-4-7-7-114-6-237 2-123 0-222-3-219-6 6-143 231-207 341-30 51-45 67-62 67-13 0-26-8-30-17-3-10-3-132 1-271 6-232 8-254 25-263 13-7 26-6 40 2 18 9 20 16 14 47-9 46-22 352-15 352 3 0 51-75 105-166 115-192 143-215 181-143 12 24 14 71 11 271-4 236-5 243-25 246-11 2-24-3-29-10z"/><path d="m4420 2875c-7-9-9-24-5-37s17-88 29-167c16-109 25-147 38-155s21-7 30 2 9 35-3 119c-8 60-14 135-14 168s-4 66-8 73c-11 17-52 15-67-3z"/><path d="m4098 2850c-50-34-109-113-128-174-16-50-8-151 15-196 24-49 63-88 109-112 78-40 202-7 250 68 33 50-12 74-55 28-38-41-77-57-124-51-56 6-89 31-120 91-33 66-33 126 1 194 47 95 151 157 169 102 4-11 18-28 31-37 23-14 26-14 44 2 30 27 24 50-22 84-57 42-108 42-170 1z"/><path d="m2896 2848c-3-7-7-33-11-58-3-25-39-133-80-240-63-169-71-198-60-215 30-48 75-24 73 39-1 58 16 96 44 96 13 0 50 9 82 20 33 11 60 20 61 20s14-27 30-60c31-65 44-75 71-56 16 12 16 17-14 79-18 36-32 72-32 79 0 8-7 24-16 37-9 12-35 78-58 144-35 104-44 122-64 125-12 2-24-3-26-10zm61-219 22-60-34-15c-19-8-42-11-53-6-18 7-18 9 6 75 14 37 28 67 31 67s16-27 28-61z"/><path d="m3285 2827c-51-20-104-57-110-77-3-11-2-27 3-37s15-58 22-108c14-104 30-149 58-164 16-9 24-7 37 5 14 15 14 19-5 50-12 18-20 44-18 56 5 36 69 37 120 2 47-33 118-111 118-130 0-7 8-17 17-23 21-12 53 3 53 25 0 25-86 130-135 165l-45 32 35 39c24 26 35 48 35 69 0 37-24 85-49 99-26 13-98 12-136-3zm115-62c29-35-33-106-107-121-28-5-33-3-37 17-3 13-2 40 2 59 6 28 15 37 42 47 48 16 85 16 100-2z"/><path d="m2610 2756c-20-8-75-20-124-27-95-15-113-28-97-71 5-13 12-48 15-78 10-76 43-178 72-222 22-34 29-38 68-38 32 0 54 8 84 30 46 33 50 41 27 60-13 11-23 9-54-8-55-31-69-28-91 21-11 23-20 47-20 53s26 17 58 23c53 10 102 39 102 60 0 5-7 14-16 22-13 10-20 10-42-3-25-15-63-22-103-19-11 1-19 13-23 35-8 43 1 65 28 71 11 2 46 9 76 15 31 6 70 19 88 30 28 17 31 23 22 40-12 23-21 24-70 6z"/><path d="m1336 2324c-19-18-20-28-6-55 20-37 80-15 80 30 0 14-29 41-45 41-7 0-21-7-29-16z"/><path d="m960 1432c-46-22-86-92-70-122 22-40 89-15 77 30-10 38 58 64 104 40 12-7 19-21 19-41 0-37-72-119-105-119-12 0-34-10-49-21-21-16-26-28-24-53 4-41 32-45 81-11 64 43 118 29 170-45 27-38 22-107-11-156-49-74-80-104-127-124-59-25-85-26-85-1s-26 34-45 15c-20-21-19-57 3-77 24-22 100-22 150-2 46 20 140 119 172 181 25 51 30 118 11 166-13 35-68 96-103 114l-29 15 22 30c23 33 35 94 25 134-14 57-115 83-186 47z"/><path d="m2470 1419c-51-30-61-46-48-75 6-13 17-24 23-24 8 0 14-52 19-177 4-98 7-192 6-209-1-38 21-58 54-50 30 7 36 31 19 73-18 46-18 144 1 137 25-9 154 35 198 69 24 18 51 49 62 70 17 36 17 40 1 83-30 79-111 123-230 124-54 0-78-5-105-21zm198-54c88-37 106-92 47-143-41-37-131-68-169-58l-27 7 3 104 3 105h53c29 0 69-7 90-15z"/><path d="m3380 1409c-82-33-139-164-128-293 5-66 24-95 93-148 89-67 166-73 231-16 38 34 43 53 16 67-14 7-25 4-47-15-16-13-39-27-52-30-32-9-105 30-149 78-37 41-37 41-31 111 7 86 47 174 82 183 30 7 46-2 38-22-6-16 23-54 42-54 15 0 45 33 45 49 0 20-43 72-72 87-31 16-34 16-68 3z"/><path d="m2984 1402c-6-4-30-45-52-92-37-77-58-141-97-295-7-27-16-58-19-67-8-16 24-58 43-58 25 0 42 33 36 71-7 43-17 38 107 62l67 13 18-43c19-45 33-56 58-47 19 8 19 37 1 72-31 61-89 230-102 301-16 82-31 103-60 83zm56-304c-7-9-111-30-118-24-7 8 18 106 41 160l21 49 31-89c17-49 28-92 25-96z"/><path d="m3955 1398c-22-5-77-8-122-5-93 5-106-1-102-55 1-18 1-97 0-175-2-124 1-149 18-188 15-34 29-49 55-60 73-31 152-14 195 41 26 33 26 41 1 54-16 8-25 5-50-20-23-23-40-30-69-30-55 0-82 25-88 83-7 55 7 77 48 77 49 0 128 21 151 40 21 17 22 20 7 35-14 15-22 15-51 6-19-6-59-12-89-14l-54-2-3 49c-6 93-3 96 88 96 82 0 125 12 135 38 5 14-11 43-24 41-3-1-24-5-46-11z"/><path d="m2040 1388c-47-13-70-36-70-68 0-36 7-40 119-80 99-35 142-64 166-111 32-62 9-121-60-153-48-23-148-38-199-31-35 6-42 10-42 28 1 31-42 35-72 7-29-27-28-56 3-76 42-27 233-24 305 4 127 51 170 139 121 247-29 64-91 108-207 145-59 19-61 28-10 35 37 6 51 4 66-10 41-37 95 9 63 54-12 18-24 21-81 20-37 0-83-5-102-11z"/><path d="m1338 864c-11-23-10-29 11-45 21-17 26-18 45-6 41 27 27 77-20 77-17 0-28-9-36-26z"/></g></svg>
</div>
</div>
<div class="paragraph">
<p>After that it was time for the boring stuff: looking for an apartment
that best fits my requirements.</p>
</div>
<div class="paragraph">
<p>I have a couple of friends in Lux and they all told me to look on the infamous
website <a href="https://athome.lu">AtHome.lu</a> to get an idea on the available
apartments that there are in Lux, so I did.</p>
</div>
<div class="paragraph">
<p>I don&#8217;t like doing this, so I try to make things easier by just
looking at the pictures and if the price looks ok I&#8217;ll just bookmark
the thing so that I can look at it later for comparisons.</p>
</div>
<div class="paragraph">
<p>This quickly becomes hard to do. Some agencies will publish part of the
monthly price, some of them will post the actual monthly price. Each
agency fee is different and it&#8217;s not immediately visible. The map
on the website is just awful and it won&#8217;t let me compare positions with other
apartments. Needless to say that it is pretty much impossible to choose
the right one with this messy data.</p>
</div>
<div class="paragraph">
<p>What I&#8217;d like to have is a big map with all the apartments that I like on
it and maybe a database to query apartments to show by different parameters.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see if we can scrape some data off of athome.lu!</p>
</div>
<div class="paragraph">
<p>After giving a quick look at the website I&#8217;ve found out that by selecting
the renting apartments in the Luxembourg area, links start with this URL path
<code>www.athome.lu/en/rent/apartment/luxembourg</code>, each apartment
has a unique id and the complete address for an apartment looks like this
<code>www.athome.lu/en/rent/apartment/luxembourg/id-642398588.html</code>.</p>
</div>
<div class="paragraph">
<p>This is a good start, it means that I can pretty much navigate to a specific apartment
page just by knowing its id.</p>
</div>
<div class="paragraph">
<p>If I inspect the html source of a single page, I immediately notice that there
is a <strong>HUGE</strong> json object with a lot of data in it at the bottom of the page,</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/initstate.png" alt="initstate">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see if we can find something interesting in it.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/initstate_console.png" alt="initstate console">
</div>
</div>
<div class="paragraph">
<p>Cool, it seems like a big object to set up the entire page. If we look at
each sub-object of <code><em>INITIAL_STATE</em></code> we find <code>detail</code> which
seems to be our lucky card.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/detail_console.png" alt="detail console">
</div>
</div>
<div class="paragraph">
<p>Great! We don&#8217;t even have to scrape data from html, we have all the data of the
apartment in this <code><em>INITIAL_STATE</em>.detail</code> object!</p>
</div>
<div class="paragraph">
<p>How can I access that variable through code though? I don&#8217;t have a great experience with it
and I don&#8217;t write a lot of JS, but I heard that <a href="https://developers.google.com/web/tools/puppeteer/">Puppeteer</a>
is the right tool for the job. Let me try something out</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="javascript"><span class="kd">const</span> <span class="nx">puppeteer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">puppeteer</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">).</span><span class="nx">promises</span><span class="p">;</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">scrape_json_data</span><span class="p">(</span><span class="nx">browser</span><span class="p">,</span> <span class="nx">link</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">page</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">newPage</span><span class="p">();</span>
    <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">goto</span><span class="p">(</span><span class="nx">link</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="p">{</span> <span class="nx">detail</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">__INITIAL_STATE__</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">detail</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">browser</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">puppeteer</span><span class="p">.</span><span class="nx">launch</span><span class="p">({</span> <span class="na">headless</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
    <span class="c1">// File where I'll save all my preferred apartments' links</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">LINKS_PATH</span><span class="p">,</span> <span class="dl">"</span><span class="s2">utf-8</span><span class="dl">"</span><span class="p">);</span>
    <span class="c1">// Read line by line</span>
    <span class="kd">const</span> <span class="nx">links</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/</span><span class="se">\r?\n</span><span class="sr">/</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">objs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">links</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">id_pattern</span> <span class="o">=</span> <span class="sr">/id-</span><span class="se">(\d</span><span class="sr">+</span><span class="se">)</span><span class="sr">/</span><span class="p">;</span>
        <span class="c1">// Take id from final part of each link</span>
        <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="nx">id_pattern</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">scraping: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">scrape_json_data</span><span class="p">(</span><span class="nx">browser</span><span class="p">,</span> <span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">found</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Remove all the superfluous data from detail obj</span>
            <span class="nx">obj</span> <span class="o">=</span> <span class="nx">clean_obj</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
            <span class="c1">// Add link to the obj, somehow it's not included in detail obj :/</span>
            <span class="nx">obj</span><span class="p">.</span><span class="nx">link</span> <span class="o">=</span> <span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="nx">objs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">objs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="na">found</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">listingId</span><span class="p">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Save obj data to json file</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">JSON_OUT</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">objs</span><span class="p">));</span>
    <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
<span class="p">})();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code above will open a headless instance of chrome, go to each
apartment link that is saved in the file at <code>LINKS_PATH</code> and
spit an array of all the apartment data in a file at <code>JSON_OUT</code>.</p>
</div>
<div class="paragraph">
<p>We were lucky this time, we didn&#8217;t have to go through scraping html,
and this would have probably been the most boring part of the entire process.
The next steps will be about storing data in a database and visualizing it,
but first let&#8217;s write a <a href="https://github.com/casey/just">justfile</a>
(alternative to a Makefile) that will make our life easier when we
need to execute commands.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="justfile">base     := justfile_directory()
json_out := "/tmp/res.json"
links    := base + "/homes.txt"

scrape:
    LINKS_PATH={{links}} \
    JSON_OUT={{json_out}} \
    node scraper/main.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>I can now scrape data by just typing</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Shell session">$ just scrape</code></pre>
</div>
</div>
<div class="paragraph">
<p>I want to save all the data to a sqlite database
so that I can conveniently check, query and get
apartments info whenever I want and however I want.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s move away from js and switch to a compiled language,
Go will fit perfectly for this, it&#8217;s fast and easy to use.</p>
</div>
<div class="paragraph">
<p>The binary will parse the entire json file that the scraper created
and load each apartment to the <code>apartment</code> table in sqlite.</p>
</div>
<div class="paragraph">
<p>I didn&#8217;t show it before, but this is my final, cleaned-from-useless-stuff
<code>Apartment</code> struct with some tag annotations to read from json and load into
sqlite by using <a href="https://github.com/jmoiron/sqlx">sqlx</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="go"><span class="k">type</span> <span class="n">Apartment</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Found</span>                  <span class="kt">bool</span>      <span class="s">`json:"found,omitempty" db:"found,omitempty"`</span>
	<span class="n">ListingId</span>              <span class="kt">uint32</span>    <span class="s">`json:"listingId,omitempty" db:"listingId,omitempty"`</span>
	<span class="n">ListingAgencyReference</span> <span class="kt">string</span>    <span class="s">`json:"listingAgencyReference,omitempty" db:"listingAgencyReference,omitempty"`</span>
	<span class="n">IsSoldProperty</span>         <span class="kt">bool</span>      <span class="s">`json:"isSoldProperty,omitempty" db:"isSoldProperty,omitempty"`</span>
	<span class="n">Region</span>                 <span class="kt">string</span>    <span class="s">`json:"region,omitempty" db:"region,omitempty"`</span>
	<span class="n">CityName</span>               <span class="kt">string</span>    <span class="s">`json:"cityName,omitempty" db:"cityName,omitempty"`</span>
	<span class="n">Lon</span>                    <span class="kt">float64</span>   <span class="s">`json:"lon,omitempty" db:"lon,omitempty"`</span>
	<span class="n">Lat</span>                    <span class="kt">float64</span>   <span class="s">`json:"lat,omitempty" db:"lat,omitempty"`</span>
	<span class="n">Price</span>                  <span class="kt">int</span>       <span class="s">`json:"price,omitempty" db:"price,omitempty"`</span>
	<span class="n">ChargesPrice</span>           <span class="kt">int</span>       <span class="s">`json:"chargesPrice,omitempty" db:"chargesPrice,omitempty"`</span>
	<span class="n">Caution</span>                <span class="kt">float32</span>   <span class="s">`json:"caution,omitempty" db:"caution,omitempty"`</span>
	<span class="n">AgencyFee</span>              <span class="kt">string</span>    <span class="s">`json:"agency_fee,omitempty" db:"agency_fee,omitempty"`</span>
	<span class="n">PropertySubType</span>        <span class="kt">string</span>    <span class="s">`json:"propertySubType,omitempty" db:"propertySubType,omitempty"`</span>
	<span class="n">PublisherId</span>            <span class="kt">int</span>       <span class="s">`json:"publisher_id,omitempty" db:"publisher_id,omitempty"`</span>
	<span class="n">PublisherRemoteVisit</span>   <span class="kt">bool</span>      <span class="s">`json:"publisher_remote_visit,omitempty" db:"publisher_remote_visit,omitempty"`</span>
	<span class="n">PublisherPhone</span>         <span class="kt">string</span>    <span class="s">`json:"publisher_phone,omitempty" db:"publisher_phone,omitempty"`</span>
	<span class="n">PublisherName</span>          <span class="kt">string</span>    <span class="s">`json:"publisher_name,omitempty" db:"publisher_name,omitempty"`</span>
	<span class="n">PublisherAthomeId</span>      <span class="kt">string</span>    <span class="s">`json:"publisher_athome_id,omitempty" db:"publisher_athome_id,omitempty"`</span>
	<span class="n">PropertySurface</span>        <span class="kt">float64</span>   <span class="s">`json:"propertySurface,omitempty" db:"propertySurface,omitempty"`</span>
	<span class="n">BuildingYear</span>           <span class="kt">string</span>    <span class="s">`json:"buildingYear,omitempty" db:"buildingYear,omitempty"`</span>
	<span class="n">FloorNumber</span>            <span class="kt">string</span>    <span class="s">`json:"floorNumber,omitempty" db:"floorNumber,omitempty"`</span>
	<span class="n">BathroomsCount</span>         <span class="kt">int</span>       <span class="s">`json:"bathroomsCount,omitempty" db:"bathroomsCount,omitempty"`</span>
	<span class="n">BedroomsCount</span>          <span class="kt">int</span>       <span class="s">`json:"bedroomsCount,omitempty" db:"bedroomsCount,omitempty"`</span>
	<span class="n">BalconiesCount</span>         <span class="kt">int</span>       <span class="s">`json:"balconiesCount,omitempty" db:"balconiesCount,omitempty"`</span>
	<span class="n">CarparkCount</span>           <span class="kt">int</span>       <span class="s">`json:"carparkCount,omitempty" db:"carparkCount,omitempty"`</span>
	<span class="n">GaragesCount</span>           <span class="kt">int</span>       <span class="s">`json:"garagesCount,omitempty" db:"garagesCount,omitempty"`</span>
	<span class="n">HasLivingRoom</span>          <span class="kt">bool</span>      <span class="s">`json:"hasLivingRoom,omitempty" db:"hasLivingRoom,omitempty"`</span>
	<span class="n">HasKitchen</span>             <span class="kt">bool</span>      <span class="s">`json:"hasKitchen,omitempty" db:"hasKitchen,omitempty"`</span>
	<span class="n">Availability</span>           <span class="kt">string</span>    <span class="s">`json:"availability,omitempty" db:"availability,omitempty"`</span>
	<span class="n">Media</span>                  <span class="o">*</span><span class="p">[]</span><span class="kt">string</span> <span class="s">`json:"media,omitempty" db:"media,omitempty"`</span>
	<span class="n">Description</span>            <span class="kt">string</span>    <span class="s">`json:"description,omitempty" db:"description,omitempty"`</span>
	<span class="n">Link</span>                   <span class="kt">string</span>    <span class="s">`json:"link,omitempty" db:"link,omitempty"`</span>
	<span class="n">CreatedAt</span>              <span class="kt">string</span>    <span class="s">`json:"createdAt,omitempty" db:"createdAt,omitempty"`</span>
	<span class="n">UpdatedAt</span>              <span class="kt">string</span>    <span class="s">`json:"updatedAt,omitempty" db:"updatedAt,omitempty"`</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I might change my mind later down the road on the data that I want to keep
in each <code>Apartment</code> struct, so I might want to make changes to the database structure,
and therefore the queries to insert and update the database too. To make this a bit more
flexible I will use a yaml file to save any database migration and insert/update
queries to the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">migrations</span><span class="pi">:</span> <span class="pi">|</span>
  <span class="s">CREATE TABLE IF NOT EXISTS apartment(</span>
      <span class="s">found BOOL,</span>
      <span class="s">listingId INTEGER PRIMARY KEY,</span>
      <span class="s">...</span>
      <span class="s">description TEXT,</span>
      <span class="s">link TEXT,</span>
      <span class="s">createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
      <span class="s">updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
  <span class="s">);</span>


<span class="na">insertQuery</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">INSERT INTO apartment(found,listingId,listingAgencyReference,isSoldProperty,region,cityName,</span>
                          <span class="s">lon,lat,price,chargesPrice,caution,agency_fee,propertySubType,publisher_id,</span>
                          <span class="s">publisher_remote_visit,publisher_phone,publisher_name,publisher_athome_id,</span>
                          <span class="s">propertySurface,buildingYear,floorNumber,bathroomsCount,bedroomsCount,balconiesCount,</span>
                          <span class="s">garagesCount,carparkCount,hasLivingRoom,hasKitchen,availability,media,description,link)</span>
    <span class="s">VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)</span>


<span class="na">updateQuery</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">UPDATE apartment</span>
    <span class="s">SET found = ?, listingId = ?, listingAgencyReference = ?, isSoldProperty = ?, region = ?, cityName = ?, lon = ?, lat = ?, price = ?,</span>
        <span class="s">chargesPrice = ?, caution = ?, agency_fee = ?, propertySubType = ?, publisher_id = ?, publisher_remote_visit = ?, publisher_phone = ?,</span>
        <span class="s">publisher_name = ?, publisher_athome_id = ?, propertySurface = ?, buildingYear = ?, floorNumber = ?, bathroomsCount = ?,</span>
        <span class="s">bedroomsCount = ?, balconiesCount = ?, garagesCount = ?, carparkCount = ?, hasLivingRoom = ?, hasKitchen = ?,</span>
        <span class="s">availability = ?, media = ?, description = ?, link = ?, updatedAt = CURRENT_TIMESTAMP</span>
    <span class="s">WHERE listingId = ?</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After setting up these basic features and with a little more code
I can compile the program and run it so that it will load the previous
json file into my sqlite <code>apartment</code> table.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add some more commands to the justfile that we&#8217;ve
created previously.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="justfile">db_path  := base + "/db.sqlite"

gobuild:
    cd {{base}}/loader; go build cmd/main.go

load: gobuild
    CONFIG_PATH={{base}}/loader/config.yaml \
    JSON_OUT={{json_out}} \
    DB_PATH={{db_path}} \
    {{base}}/loader/main

fetch: scrape load</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s load the data into database</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Shell session">$ just load
&gt; OR
$ just fetch
&gt; which will first scrape data and then load it in the database
&gt; justfiles are cool!</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just to get some specs, this runs fast. Take a look</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Shell session">$ cat home.txt | wc
  65      66    4469
$ time just load
just load  0.38s user 0.52s system 220% cpu 0.408 total</code></pre>
</div>
</div>
<div class="paragraph">
<p>I now have all the data that I scraped in my nice and super fast
database, ready to be queried with the craziest query that comes
to my mind, I can think of some.</p>
</div>
<div class="paragraph">
<p>We&#8217;re at a going point at the moment, I have a lot of parameters
with which I can query apartments that I like. I can select them by
non-decreasing price, by area and if I add some more complex Haversine
formulae I could also sort them by distance from the city centre or any
other map coordinates.</p>
</div>
<div class="paragraph">
<p>I won&#8217;t stop here though. I have some interesting little vars in
each apartment data: <code>lat</code>, <code>lon</code>. I don&#8217;t want to waste geo data!
It&#8217;s nice and fun to just look at tabular data, but I think I could
get an easier idea of the location just by plotting stuff on a map.</p>
</div>
<div class="paragraph">
<p>I want to code something quick with the smallest amount of code, so I&#8217;ll
go with Python and Jupyter notebook in conjunction with
<a href="https://python-visualization.github.io/folium/">Folium</a> which is
a library that generates <a href="https://leafletjs.com/">Leaflet</a> maps.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s setup the map with my point of interest</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">import</span> <span class="nn">folium</span>

<span class="n">lux_coords</span> <span class="o">=</span> <span class="p">[</span><span class="mf">49.611622</span><span class="p">,</span> <span class="mf">6.131935</span><span class="p">]</span>
<span class="n">map_</span> <span class="o">=</span> <span class="n">folium</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">lux_coords</span><span class="p">,</span> <span class="n">zoom_start</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">interesting_coords</span> <span class="o">=</span> <span class="p">[</span><span class="mf">49.630033</span><span class="p">,</span> <span class="mf">6.168936</span><span class="p">]</span>
<span class="n">folium</span><span class="p">.</span><span class="n">Marker</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">interesting_coords</span><span class="p">,</span> <span class="n">popup</span><span class="o">=</span><span class="s">"Point of interest"</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="n">folium</span><span class="p">.</span><span class="n">Icon</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'red'</span><span class="p">)).</span><span class="n">add_to</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>

<span class="n">folium</span><span class="p">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">interesting_coords</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'green'</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">2</span><span class="p">).</span><span class="n">add_to</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>
<span class="n">folium</span><span class="p">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">interesting_coords</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'yellow'</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">2</span><span class="p">).</span><span class="n">add_to</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>
<span class="n">folium</span><span class="p">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">interesting_coords</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">15000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'orange'</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">2</span><span class="p">).</span><span class="n">add_to</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>
<span class="n">folium</span><span class="p">.</span><span class="n">Circle</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">interesting_coords</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'red'</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">2</span><span class="p">).</span><span class="n">add_to</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will show a map centered on Lux, with a cool red pin on my point of interest
and to get a better idea of the distance, I also added some circles with a radius of
5km, 10km, 15km and 20km. This is extremely useful because I can discard immediately
by looking at the map of apartments that are too far from my point of interest.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/poi.png" alt="poi">
</div>
</div>
<div class="paragraph">
<p>Before going crazy with SQL I need to add my scraped apartments
to the map and for the sake of simplicity I will query them all here</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>


<span class="k">def</span> <span class="nf">getApartments</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cur</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">"""
        SELECT *
        FROM apartment
        WHERE
            found = TRUE
        """</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">Apartment</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">fetchall</span><span class="p">()]</span>


<span class="k">def</span> <span class="nf">addApartment</span><span class="p">(</span><span class="n">map_</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="n">popup</span> <span class="o">=</span> <span class="n">folium</span><span class="p">.</span><span class="n">Popup</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">_popup_</span><span class="p">(),</span> <span class="n">max_width</span><span class="o">=</span><span class="mi">450</span><span class="p">)</span>
    <span class="n">folium</span><span class="p">.</span><span class="n">Marker</span><span class="p">(</span>
        <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="p">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">lon</span><span class="p">],</span>
        <span class="n">popup</span><span class="o">=</span><span class="n">popup</span><span class="p">,</span>
        <span class="c1"># I can use fontawesome to change the pin icon
</span>        <span class="n">icon</span><span class="o">=</span><span class="n">folium</span><span class="p">.</span><span class="n">Icon</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">a</span><span class="p">.</span><span class="n">_get_color</span><span class="p">(),</span> <span class="n">icon</span><span class="o">=</span><span class="n">a</span><span class="p">.</span><span class="n">_get_icon</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s">"fa"</span><span class="p">)</span>
    <span class="p">).</span><span class="n">add_to</span><span class="p">(</span><span class="n">map_</span><span class="p">)</span>


<span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"DB_PATH"</span><span class="p">])</span>
<span class="n">apartments</span> <span class="o">=</span> <span class="n">getApartments</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">apartments</span><span class="p">:</span>
    <span class="n">addApartment</span><span class="p">(</span><span class="n">map_</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
<span class="n">map_</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/poi_apartments.png" alt="poi apartments">
</div>
</div>
<div class="paragraph">
<p>And here we have it! Definitely a much better experience
than going back and forth on the website and drawing on a map
all the apartments one by one, right?</p>
</div>
<div class="paragraph">
<p>In the code above you can see that I&#8217;ve used a custom popup for each
apartment. With Folium we can use HTML to customize the pin&#8217;s popup
with the most important information I want to see (i.e. monthly total price, initial fee,
caution etc.)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="k">def</span> <span class="nf">_popup_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s">"""
    &lt;h4&gt;Info&lt;/h4&gt;
    &lt;b&gt;ID: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">listingId</span><span class="si">}</span><span class="s">&lt;br&gt;
    &lt;b&gt;Monthly Price: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">price</span><span class="si">}</span><span class="s">&lt;br&gt;
    &lt;b&gt;Monthly Charge: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">chargesPrice</span><span class="si">}</span><span class="s">&lt;br&gt;
    &lt;b&gt;Caution: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">caution</span><span class="si">}</span><span class="s">&lt;br&gt;
    &lt;b&gt;Agency Fee: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">agencyFee</span><span class="si">}</span><span class="s">
    &lt;br&gt;
    &lt;h4&gt;Total&lt;/h4&gt;
    &lt;b&gt;Monthly: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">price</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">chargesPrice</span><span class="si">}</span><span class="s">&lt;br&gt;
    &lt;b&gt;Initial: &lt;/b&gt;</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">caution</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">agencyFee</span><span class="si">}</span><span class="s">&lt;br&gt;&lt;br&gt;
    &lt;a href="</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">link</span><span class="si">}</span><span class="s">" target="_blank"&gt;Page&lt;/a&gt;&lt;br&gt;
    &lt;a href="</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">galleryLink</span><span class="si">}</span><span class="s">" target="_blank"&gt;Gallery&lt;/a&gt;&lt;br&gt;
    """</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/images/popup.png" alt="popup">
</div>
</div>
<div class="paragraph">
<p>That&#8217;s just what I wanted, I can now see on the map which are the best
located apartments in Lux and immediately get to see the info that I&#8217;m
interested in the most!</p>
</div>
<div class="paragraph">
<p>Why would I save the data on a database if I don&#8217;t use SQL at all?
Let&#8217;s say that I have a base budget of 1000€ and I want to show only
the apartments on which I would have to spend an incremental amount of 200€,
I could simply change the SQL query to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">apartment</span>
<span class="k">WHERE</span>
    <span class="k">found</span> <span class="o">=</span> <span class="k">TRUE</span> <span class="k">AND</span>
    <span class="n">listingId</span> <span class="k">IN</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="n">listingId</span>
        <span class="k">FROM</span> <span class="n">apartment</span>
        <span class="k">WHERE</span>
            <span class="k">found</span> <span class="o">=</span> <span class="k">TRUE</span> <span class="k">AND</span>
            <span class="n">price</span> <span class="o">+</span> <span class="n">chargesPrice</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">+</span> <span class="mi">200</span>
    <span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Phewww, if you&#8217;re still here reading all this you deserve a bonus point.</p>
</div>
<div class="paragraph">
<p>Imagine I saw a very cool apartment that looks like a very good deal but
it&#8217;s a bit out of the city, what&#8217;s the best way to know how much it is going
to take me to get from that apartment to my point of interest with public transportation?</p>
</div>
<div class="paragraph">
<p>If you paid close attention to the image above you might already know the answer,
Google Maps of course! Google Maps is very cool, you can get directions from
position x to position y by visiting <code>www.google.com/maps/dir/x.lat,x.lon/y.lat,y.lon</code>.</p>
</div>
<div class="paragraph">
<p>All I need to do is add <code>&lt;a href="{self.mapsDir}" target="_blank"&gt;Maps Directions&lt;/a&gt;</code>
to the popup dialog I pasted above and I will have a very handy link that
will open Google Maps on a new tab with the time travel from position x to y.</p>
</div>
<div class="paragraph">
<p>This will save me so much time, you have no idea!</p>
</div>
<div class="paragraph">
<p>Why don&#8217;t we finish this by completing our justfile? In the end I
want to type a single command and be shown the map with all the apartments
that I saved on my file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="justfile">open:
    DB_PATH={{db_path}} \
    jupyter notebook \
    {{base}}/analyzer/apartments.ipynb

show: fetch open</code></pre>
</div>
</div>
<div class="paragraph">
<p>That is so convenient, I can finally only look at pictures of cool
apartments, save the link on my file and at the end of the day type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="Shell session">$ just show</code></pre>
</div>
</div>
<div class="paragraph">
<p>Life is good now, at least I made the process funnier and more efficient
than before!</p>
</div>
<div class="paragraph">
<p>The only thing that is <em>very slow</em> at the moment is the first js snippet,
it takes ~1s to get a single apartment, multiply
that for 100 apartments and you will have to wait for a couple of minutes before
seeing all the pins on the map. The immediate solution would be to make multiple
page requests at a time but I&#8217;m not much of an expert with `Promise`s so I think
I&#8217;ll stick with this solution until I&#8217;m not bored again to wait
for the tool to scrape each link.</p>
</div>
<div class="paragraph">
<p>I now need to get back to hunting that apartment, wish me luck!</p>
</div>
  
  <div class="patreon-block">
    <h2>Enjoyed the read?</h2>
    <p>If you enjoy my writing, please check out my Patreon 
      <b><a href="https://www.patreon.com/mattrighetti">patreon.com/mattrighetti</a></b>
      and become my supporter. Sharing the article is also greatly appreciated.</p>
  </div>
  
</article>

<script>
    function renderCodeTags() {
        const collection = document.getElementsByClassName("rouge highlight");

        for (let i = 0; i < collection.length; i++) {
        let cNode = collection[i].firstChild;
        let lang = cNode.getAttribute("data-lang");

        let newNode = document.createElement("div");
        newNode.className = "lang-tag";
        newNode.innerHTML += lang;

        collection[i].insertBefore(newNode, cNode);
        }
    }

    renderCodeTags()
</script>

    </main>

    <footer>
        <p>
            <a href="https://patreon.com/mattrighetti">
                <i class="fa-brands fa-patreon"></i>
            </a>

            <a href=" /feed.xml">
                <i class="fa fa-rss"></i> RSS
            </a>

            <a href="https://github.com/mattrighetti">
                <i class="fa fa-github"></i> mattrighetti
            </a>

            <a href="https://www.youtube.com/channel/UCaLpe7l5BS4slR2bL2n-bmg">
                <i class="fa fa-youtube-play"></i>
            </a>
        </p>
    </footer>
    <!-- <script src=" /js/chartist.min.js"></script> -->
    <script>
        const toggle = document.getElementById('theme-toggle');

        var storedTheme = localStorage.getItem('theme') || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
        if (storedTheme)
            document.documentElement.setAttribute('data-theme', storedTheme)

        toggle.onclick = function() {
            console.log("Switching theme");
            var currentTheme = document.documentElement.getAttribute("data-theme");
            var targetTheme = "light";

            if (currentTheme === "light") {
                targetTheme = "dark";
            }

            document.documentElement.setAttribute('data-theme', targetTheme)
            localStorage.setItem('theme', targetTheme);
        };
    </script>
</body>
</html>
